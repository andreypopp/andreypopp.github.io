(window.webpackJsonp=window.webpackJsonp||[]).push([["394d"],{vNFN:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/writings/2013-11-08-making-express-type-safe-with-typescript-and-promises",function(){var e=n("zNf3");return{page:e.default||e}}])},zNf3:function(e,t,n){"use strict";n.r(t),n.d(t,"title",function(){return s}),n.d(t,"default",function(){return c});var a=n("z3IF"),o=n("2Fjn"),r=(n("mXGw"),n("SAVP")),i=n("SGno"),s="Making express type safe with TypeScript and promises",p={title:s},l=i.a;function c(e){var t=e.components,n=Object(o.a)(e,["components"]);return Object(r.b)(l,Object(a.a)({},p,n,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,"Recently I've tried to evaluate TypeScript for use in a project which is\na simple REST API I was going to implement with Node.js and Express."),Object(r.b)("p",null,"In this blog post I want to share my observations regarding TypeScript and how\nit can (or cannot) help you develop applications targeting JavaScript runtimes."),Object(r.b)("h2",null,"Shortly on what TypeScript is about"),Object(r.b)("p",null,"TypeScript is a language from Microsoft which compiles to JavaScript. That means\nyou can write code in TypeScript which then can be executed in a browser or in\nNode.js or any other JavaScript runtime."),Object(r.b)("p",null,"While there are other languages which target JavaScript, TypeScript is\ninteresting because it is optionally statically typed, its type system supports\nstructural typing and its compiler can infer types in a number of common cases."),Object(r.b)("p",null,"All these properties promise very little or no boilerplate when compared to such\nmainstream statically typed languages like Java, C++ and the likes."),Object(r.b)("p",null,"In addition to that, TypeScript syntax is a superset of JavaScript syntax with\naddition of type annotations and a couple of other ES6 (the next standard for\nJavaScript) features which in the near future will hit mainstream browsers. We\ncan say that TypeScript and JavaScript syntaxes converge to each other for the\nexception of type annotations which will never be the part of JavaScript."),Object(r.b)("p",null,"The basic example of TypeScript code looks like that:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{}),"var a: Number = 1;\n\nvar showNumber = function(num: Number): String {\n  return 'Number is: ' + num.toString();\n}\n\nvar b: String = showNumber(a);\n")),Object(r.b)("p",null,"I think, it looks friendly to anyone who has experience with JavaScript."),Object(r.b)("p",null,"Note the type annotations, while they are absolutely optional in this case (as I\nsaid TypeScript compiler can infer them for you) they show precisely what types\nvariables and a function have."),Object(r.b)("p",null,"I advice to describe types for top level functions and variable. Even if this is\nunnecessary it helps a lot for other people to reason about what program is\ndoing."),Object(r.b)("p",null,"Think of it as of writing jsdoc comments which are less verbose and checked by\nthe compiler so they can't be wrong or outdated."),Object(r.b)("h2",null,"How types can improve my Express app"),Object(r.b)("p",null,"So we are going to use TypeScript to write an Express application."),Object(r.b)("p",null,"As you know an Express app consist of a number of middlewares configured to work\ntogether. Some of them can depend on others being present up in a stack."),Object(r.b)("p",null,"I think it would be useful to have type system validate our middleware and\nhandler stacks configurations."),Object(r.b)("p",null,"For example, a handler for POST method probably would require JSON body to be\nparsed by some middleware like ",Object(r.b)("inlineCode",{parentName:"p"},"express.json()"),". If the latter isn't present in\nthe right place in the stack — handler will fail at runtime."),Object(r.b)("p",null,"It turns out we can express dependencies between middlewares in Express\napplication in type system and with the help of TypeScript compiler prove\nconfiguration to be correct before even running an application."),Object(r.b)("h2",null,"Designing type-friendly APIs"),Object(r.b)("p",null,"There a little care needed to design APIs which are friendly to type systems.\nFortunately this also means those APIs will be much more intuitive and easy to\nreason about."),Object(r.b)("p",null,"This is the case even without any type system.  But if you're lucky and have a\nproper type system in place then it can help you catch mistakes and even say\nwhat's wrong with you code."),Object(r.b)("p",null,"So what's this all about, type friendly APIs?"),Object(r.b)("p",null,"There are two obvious things you should remember when you are working with\ntypes:"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},"Types are attached to values"),Object(r.b)("li",{parentName:"ol"},"You cannot change the type of a value but only apply a function to the\nvalue and get another value of another type")),Object(r.b)("p",null,"The first thing is super obvious — can you imagine type without a value? How\nuseful is that?"),Object(r.b)("p",null,"The second point is just as obvious — if you have a value of type ",Object(r.b)("inlineCode",{parentName:"p"},"A")," and a\nfunction with an argument of type ",Object(r.b)("inlineCode",{parentName:"p"},"A")," and a returned value of type ",Object(r.b)("inlineCode",{parentName:"p"},"B")," then you can\napply this function to a value you will get another value of type ",Object(r.b)("inlineCode",{parentName:"p"},"B")),Object(r.b)("p",null,"That second point makes express handlers/middlewares are not best suited for our\npurposes — they mutate a request but don't return it."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{}),"function middleware(req, res, next) {\n  db.connect(function(err, conn) {\n    if (err)\n      return next(err);\n    req.conn = conn;\n    next()\n  });\n}\n")),Object(r.b)("p",null,"This is an example of middleware which connects to a database and calls the next\nmiddleware in chain. Unfortunately type system can't know if this function\ntransforms request or not and so can't provide us with statically verifiable\nguarantees."),Object(r.b)("p",null,"To workaround the limitation we are going to define a new API for express which\nis based on promises."),Object(r.b)("h2",null,"Typing promises"),Object(r.b)("p",null,"For promises I'm going to use ","[kew][]"," library."),Object(r.b)("p",null,"It's written in JavaScript and so we should provide TypeScript compiler with\ndescription of types of the library. This should be done once for any JavaScript\nlibrary you are going to use in the project. Fortunately there's DefinitelyTyped\nproject which provides type definitions for most of the popular JavaScript\nlibraries."),Object(r.b)("p",null,"Promises are containers for values so we are going to describe it as a generic\ntype, e.g. a type which can be parametrized by other type."),Object(r.b)("p",null,"This is the contents of file ",Object(r.b)("inlineCode",{parentName:"p"},"kew.d.ts"),":"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{}),'declate module "kew" {\n  export function defer<A>(): Promise<A>;\n  export function resolve<A>(value: A): Promise<A>;\n  export function reject<A>(err: Error): Promise<A>;\n  export interface Promise;\n}\n\ninterface Promise<A> {\n  then<B>(\n      onResult: (value: A) => Promise<B>,\n      onFailure?: (err: Error) => any): Promise<B>\n  then<B>(\n      onResult: (value: A) => B,\n      onFailure?: (err: Error) => any): Promise<B>\n  resolve(value: A): void\n  reject(err: Error): void\n}\n')),Object(r.b)("p",null,"So the following code would compile and run:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{}),"kew.resolve(1).then(function(x) { return x + 1; });\n")),Object(r.b)("p",null,"but this won't even compile:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{}),"kew.resolve(1).then(function(x) { return x.substring(1); });\n")),Object(r.b)("p",null,"because the function passed to ",Object(r.b)("inlineCode",{parentName:"p"},"then")," expects an argument of type ",Object(r.b)("inlineCode",{parentName:"p"},"Number"),"."),Object(r.b)("h2",null,"Type friendly express API"))}c.isMDXComponent=!0}},[["vNFN","5d41","9da1"]]]);